<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interval Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --system-blue: #007AFF;
            --system-emerald: #10b981;
            --system-orange: #f59e0b;
            --system-background: #000000;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--system-background);
            background-image: 
                radial-gradient(at 0% 0%, rgba(0, 122, 255, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(88, 86, 214, 0.15) 0px, transparent 50%);
            color: #FFFFFF;
            overflow: hidden;
            height: 100dvh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .apple-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .view-stack {
            position: relative;
            flex: 1;
            width: 100%;
            min-height: 0;
        }

        .tab-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black; 
            display: none; 
            flex-direction: column;
            overflow-y: auto;
            z-index: 1;
        }

        .tab-view.active {
            display: flex;
            z-index: 2;
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.4s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .nav-container {
            position: relative;
            display: flex;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 4px;
            margin: 0 24px 24px 24px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            flex-shrink: 0;
        }

        .tab-btn {
            position: relative;
            flex: 1;
            padding: 8px 0;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.4);
            z-index: 10;
        }

        .tab-active { color: #FFFFFF; }

        .tab-indicator {
            position: absolute;
            top: 4px;
            left: 4px;
            height: calc(100% - 8px);
            width: calc(50% - 4px);
            background: rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
            z-index: 5;
        }

        .ios-button {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s;
        }

        .ios-button:active { transform: scale(0.92); opacity: 0.8; }

        @keyframes pulseBig {
            0%, 100% { 
                transform: scale(1);
            }
            50% { 
                transform: scale(1.15);
            }
        }

        @keyframes pulseCircleGlow {
            0%, 100% { 
                stroke-width: 10;
                opacity: 0.7;
            }
            50% { 
                stroke-width: 12;
                opacity: 0.9;
            }
        }
        
        @keyframes pulseRadialGlow {
            0%, 100% { 
                opacity: 0.2;
                transform: scale(1);
            }
            50% { 
                opacity: 0.4;
                transform: scale(1.1);
            }
        }

        .pulse-text {
            animation: pulseBig 1s ease-in-out infinite;
        }

        .pulse-circle-stroke {
            animation: pulseCircleGlow 1s ease-in-out infinite;
        }
        
        .pulse-radial-glow {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(253, 224, 71, 0.25) 0%, rgba(253, 224, 71, 0.15) 30%, rgba(253, 224, 71, 0.06) 50%, rgba(253, 224, 71, 0.02) 70%, transparent 85%);
            animation: pulseRadialGlow 1s ease-in-out infinite;
            pointer-events: none;
            z-index: 1;
            filter: blur(12px);
        }

        @media (max-height: 700px) {
            header { padding-top: 1.5rem !important; margin-bottom: 0.5rem !important; }
            .nav-container { margin-bottom: 1rem !important; margin-left: 1.5rem !important; margin-right: 1.5rem !important; }
            #time-left { font-size: 4.5rem !important; }
            #current-exercise { font-size: 1.1rem !important; }
            .progress-svg-container { max-width: 260px !important; }
            .media-controls { margin-top: 0.5rem !important; gap: 1rem !important; }
            .exercise-label-container { height: 52px !important; }
            #view-timer { gap: 1rem !important; }
        }

        @media (max-width: 400px) {
            .progress-svg-container { 
                max-width: 280px !important; 
            }
            .exercise-label-container {
                width: 150px !important;
            }
            #current-exercise {
                font-size: 1.35rem !important;
            }
        }

        .exercise-label-container {
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            overflow: hidden;
        }
        
        #current-exercise {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
            max-width: 100%;
            text-align: center;
            white-space: normal;
            word-break: break-word;
        }
    </style>
</head>
<body>

    <div class="max-w-md w-full h-full flex flex-col relative overflow-hidden">
        
        <header class="flex justify-between items-center px-8 pt-10 mb-3 flex-shrink-0">
            <div class="flex flex-col gap-1 min-w-[140px]">
                <span class="text-[10px] font-black tracking-[0.4em] text-white/30 uppercase">Interval Timer</span>
            </div>
            <button id="btn-mute" onclick="toggleMute()" class="flex items-center justify-center p-3 h-10 w-10 rounded-2xl apple-glass border-white/5 shadow-xl">
                <svg id="icon-unmuted" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
                <svg id="icon-muted" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
            </button>
        </header>

        <nav class="nav-container">
            <button onclick="switchTab('timer')" id="tab-timer" class="tab-btn tab-active">Timer</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn">Settings</button>
            <div id="nav-indicator" class="tab-indicator"></div>
        </nav>

        <div class="view-stack">
            <div id="view-timer" class="tab-view active pb-8 flex flex-col gap-6 pt-8 justify-center">
                <div class="relative w-full flex items-center justify-center px-4">
                    <div id="visual-pulse" class="absolute w-64 h-64 rounded-full bg-blue-500/10 blur-[80px] opacity-0 transition-opacity duration-500"></div>
                    <div class="progress-svg-container relative w-full max-w-[320px] aspect-square flex items-center justify-center">
                        <svg class="absolute inset-0 w-full h-full z-0" viewBox="0 0 320 320">
                            <circle class="text-white/5" stroke-width="12" stroke="currentColor" fill="transparent" r="148" cx="160" cy="160" />
                            <circle id="progress-circle" class="progress-ring__circle text-blue-500" stroke-width="12" stroke-dasharray="930" stroke-dashoffset="0" stroke-linecap="round" stroke="currentColor" fill="transparent" r="148" cx="160" cy="160" />
                        </svg>
                        <div class="relative z-10 flex flex-col items-center justify-center text-center select-none p-4 w-full">
                            <div class="exercise-label-container">
                                <span id="current-exercise" class="text-blue-400 font-black tracking-wide uppercase text-2xl">Get Ready</span>
                            </div>
                            <span id="time-left" class="text-[5.5rem] font-black tracking-tighter tabular-nums leading-none mt-1">00:00</span>
                            <div class="mt-3 flex flex-col items-center min-h-[68px]">
                                <span id="round-display" class="text-[10px] font-black text-white/30 uppercase tracking-[0.4em]">Ready</span>
                                <span id="circuit-display" class="text-[9px] font-bold text-blue-500/50 uppercase tracking-[0.2em] mt-1"> </span>
                                <span id="total-time-display" class="text-[9px] font-bold text-white/40 uppercase tracking-[0.2em] mt-1 transition-opacity duration-300">Total: --:--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="next-up-container" class="flex flex-col items-center justify-center opacity-0 transition-all duration-500 transform translate-y-2">
                    <div class="flex items-center gap-2">
                        <span class="text-[8px] font-black text-white/20 uppercase tracking-[0.5em]">Next</span>
                        <span id="next-exercise-name" class="text-lg font-bold text-white/60 uppercase tracking-widest text-center">---</span>
                    </div>
                </div>

                <div class="media-controls w-full px-12 flex items-center justify-center gap-6 mt-2">
                    <button id="btn-reset" class="ios-button h-16 w-16 bg-white/5 text-white/70 rounded-full flex items-center justify-center border border-white/10 backdrop-blur-md font-semibold text-[10px] uppercase tracking-wider hover:bg-white/10 hover:text-white transition-all">
                        Reset
                    </button>
                    <div class="relative h-20 w-20">
                        <button id="btn-start" class="ios-button absolute inset-0 bg-white text-black rounded-full flex items-center justify-center shadow-2xl font-bold text-sm uppercase tracking-wide">
                            Start
                        </button>
                        <button id="btn-pause" class="ios-button hidden absolute inset-0 bg-white text-black rounded-full flex items-center justify-center shadow-2xl font-bold text-xs uppercase tracking-wide">
                            Pause
                        </button>
                    </div>
                    <button onclick="nextPhase()" class="ios-button h-16 w-16 bg-white/5 text-white/70 rounded-full flex items-center justify-center border border-white/10 backdrop-blur-md font-semibold text-[10px] uppercase tracking-wider hover:bg-white/10 hover:text-white transition-all">
                        Skip
                    </button>
                </div>
            </div>

            <div id="view-settings" class="tab-view px-8 pb-10">
                <div class="space-y-4 pt-4">
                    <div class="apple-glass rounded-[24px] p-5 space-y-3">
                        <label class="text-[10px] font-black text-white/40 uppercase tracking-widest">Exercise List</label>
                        <textarea id="input-exercises" rows="3" placeholder="Exercise:duration (e.g., Push ups:30)&#10;Or just exercise name for default work time" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-xs focus:ring-2 focus:ring-blue-500/50 outline-none resize-none placeholder:text-white/20">Jumping jacks:30, Push ups:30, Crunches:30, Walk outs, Squats, Mountain climbers</textarea>
                        <div class="flex items-center gap-2 text-[9px] text-white/30">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
                            <span>Separate with commas. Add :seconds for custom duration</span>
                        </div>
                    </div>
                    
                    <div class="apple-glass rounded-[24px] p-5 space-y-3">
                        <label class="text-[10px] font-black text-white/40 uppercase tracking-widest mb-1 block">Intervals</label>
                        
                        <!-- Work -->
                        <div class="grid grid-cols-[1fr_auto] gap-4 items-center py-1">
                            <span class="text-sm font-semibold text-white/70">Work</span>
                            <div class="flex items-center gap-2">
                                <input 
                                    type="text" 
                                    id="input-work" 
                                    value="00:45" 
                                    data-seconds="45"
                                    onclick="this.select()"
                                    onblur="handleTimeBlur('input-work')"
                                    class="w-16 bg-transparent text-xl font-black text-right outline-none tabular-nums">
                                <button 
                                    class="spinner-btn ios-button w-9 h-9 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-white/60 hover:bg-white/10 hover:text-white transition-all active:scale-90"
                                    onmousedown="startTimeDecrement('input-work')"
                                    onmouseup="stopAdjustment()"
                                    onmouseleave="stopAdjustment()"
                                    ontouchstart="startTimeDecrement('input-work')"
                                    ontouchend="stopAdjustment()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" d="M20 12H4"/></svg>
                                </button>
                                <button 
                                    class="spinner-btn ios-button w-9 h-9 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-white/60 hover:bg-white/10 hover:text-white transition-all active:scale-90"
                                    onmousedown="startTimeIncrement('input-work')"
                                    onmouseup="stopAdjustment()"
                                    onmouseleave="stopAdjustment()"
                                    ontouchstart="startTimeIncrement('input-work')"
                                    ontouchend="stopAdjustment()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" d="M12 4v16m8-8H4"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Rest -->
                        <div class="grid grid-cols-[1fr_auto] gap-4 items-center py-1">
                            <span class="text-sm font-semibold text-white/70">Rest</span>
                            <div class="flex items-center gap-2">
                                <input 
                                    type="text" 
                                    id="input-rest" 
                                    value="00:15" 
                                    data-seconds="15"
                                    onclick="this.select()"
                                    onblur="handleTimeBlur('input-rest')"
                                    class="w-16 bg-transparent text-xl font-black text-right outline-none tabular-nums">
                                <button 
                                    class="spinner-btn ios-button w-9 h-9 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-white/60 hover:bg-white/10 hover:text-white transition-all active:scale-90"
                                    onmousedown="startTimeDecrement('input-rest')"
                                    onmouseup="stopAdjustment()"
                                    onmouseleave="stopAdjustment()"
                                    ontouchstart="startTimeDecrement('input-rest')"
                                    ontouchend="stopAdjustment()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" d="M20 12H4"/></svg>
                                </button>
                                <button 
                                    class="spinner-btn ios-button w-9 h-9 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-white/60 hover:bg-white/10 hover:text-white transition-all active:scale-90"
                                    onmousedown="startTimeIncrement('input-rest')"
                                    onmouseup="stopAdjustment()"
                                    onmouseleave="stopAdjustment()"
                                    ontouchstart="startTimeIncrement('input-rest')"
                                    ontouchend="stopAdjustment()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" d="M12 4v16m8-8H4"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Prep -->
                        <div class="grid grid-cols-[1fr_auto] gap-4 items-center py-1">
                            <span class="text-sm font-semibold text-white/70">Prep</span>
                            <div class="flex items-center gap-2">
                                <input 
                                    type="text" 
                                    id="input-prepare" 
                                    value="00:10" 
                                    data-seconds="10"
                                    onclick="this.select()"
                                    onblur="handleTimeBlur('input-prepare')"
                                    class="w-16 bg-transparent text-xl font-black text-right outline-none tabular-nums">
                                <button 
                                    class="spinner-btn ios-button w-9 h-9 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-white/60 hover:bg-white/10 hover:text-white transition-all active:scale-90"
                                    onmousedown="startTimeDecrement('input-prepare')"
                                    onmouseup="stopAdjustment()"
                                    onmouseleave="stopAdjustment()"
                                    ontouchstart="startTimeDecrement('input-prepare')"
                                    ontouchend="stopAdjustment()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" d="M20 12H4"/></svg>
                                </button>
                                <button 
                                    class="spinner-btn ios-button w-9 h-9 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-white/60 hover:bg-white/10 hover:text-white transition-all active:scale-90"
                                    onmousedown="startTimeIncrement('input-prepare')"
                                    onmouseup="stopAdjustment()"
                                    onmouseleave="stopAdjustment()"
                                    ontouchstart="startTimeIncrement('input-prepare')"
                                    ontouchend="stopAdjustment()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" d="M12 4v16m8-8H4"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Divider -->
                        <div class="border-t border-white/10 my-2"></div>
                        
                        <!-- Circuits -->
                        <div class="grid grid-cols-[1fr_auto] gap-4 items-center py-1">
                            <span class="text-sm font-semibold text-white/70">Circuits</span>
                            <div class="flex items-center gap-2">
                                <span class="text-xl font-black tabular-nums text-white min-w-[3ch] text-right">
                                    <input 
                                        type="number" 
                                        id="input-rounds" 
                                        value="3" 
                                        min="1" 
                                        max="99"
                                        onclick="this.select()"
                                        class="w-12 bg-transparent text-xl font-black text-center outline-none tabular-nums inline">
                                </span>
                                <button 
                                    class="spinner-btn ios-button w-9 h-9 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-white/60 hover:bg-white/10 hover:text-white transition-all active:scale-90"
                                    onmousedown="startDecrement('input-rounds')"
                                    onmouseup="stopAdjustment()"
                                    onmouseleave="stopAdjustment()"
                                    ontouchstart="startDecrement('input-rounds')"
                                    ontouchend="stopAdjustment()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" d="M20 12H4"/></svg>
                                </button>
                                <button 
                                    class="spinner-btn ios-button w-9 h-9 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-white/60 hover:bg-white/10 hover:text-white transition-all active:scale-90"
                                    onmousedown="startIncrement('input-rounds')"
                                    onmouseup="stopAdjustment()"
                                    onmouseleave="stopAdjustment()"
                                    ontouchstart="startIncrement('input-rounds')"
                                    ontouchend="stopAdjustment()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" d="M12 4v16m8-8H4"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="message-box" class="fixed top-8 left-1/2 -translate-x-1/2 px-8 py-3 rounded-full apple-glass text-white font-black text-[10px] shadow-2xl transition-all opacity-0 pointer-events-none z-50 uppercase tracking-widest">Workout Complete</div>
    </div>

    <script>
        // ============================================
        // WAKE LOCK MANAGER
        // ============================================
        class WakeLockManager {
            constructor() {
                this.wakeLock = null;
                this.isSupported = 'wakeLock' in navigator;
            }

            async enable() {
                if (!this.isSupported) {
                    console.warn('Wake Lock API is not supported in this browser');
                    return;
                }

                try {
                    this.wakeLock = await navigator.wakeLock.request('screen');
                    console.log('âœ“ Wake Lock enabled - screen will stay on');
                    
                    this.wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock was released');
                    });
                } catch (err) {
                    console.error('Failed to enable Wake Lock:', err);
                }
            }

            async disable() {
                if (this.wakeLock) {
                    try {
                        await this.wakeLock.release();
                        this.wakeLock = null;
                        console.log('âœ“ Wake Lock disabled');
                    } catch (err) {
                        console.error('Error releasing Wake Lock:', err);
                    }
                }
            }

            async reEnable() {
                if (this.wakeLock !== null || this.isSupported) {
                    await this.disable();
                    await this.enable();
                }
            }
        }

        const wakeLockManager = new WakeLockManager();

        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && timer && !isPaused) {
                await wakeLockManager.reEnable();
            }
        });

        // ============================================
        // SPEECH SYNTHESIS MANAGER (iOS-Compatible)
        // ============================================
        class SpeechManager {
            constructor() {
                this.isInitialized = false;
                this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            }

            initialize() {
                if (this.isInitialized) return;
                
                if (this.isIOS && 'speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('');
                    utterance.volume = 0;
                    window.speechSynthesis.speak(utterance);
                    this.isInitialized = true;
                    console.log('âœ“ Speech synthesis initialized for iOS');
                } else {
                    this.isInitialized = true;
                }
            }

            speak(text, voiceEnabled) {
                if (!voiceEnabled) return;
                
                if (!this.isInitialized) {
                    this.initialize();
                }

                window.speechSynthesis.cancel();

                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 1.1;
                    utterance.volume = 1.0;
                    utterance.lang = 'en-US';
                    
                    if (this.isIOS) {
                        utterance.rate = 1.0;
                    }
                    
                    window.speechSynthesis.speak(utterance);
                    console.log('ðŸ”Š Speaking:', text);
                }, this.isIOS ? 100 : 0);
            }

            cancel() {
                window.speechSynthesis.cancel();
            }
        }

        const speechManager = new SpeechManager();

        // ============================================
        // TIMER CODE
        // ============================================
        const CIRCLE_RADIUS = 148;
        const CIRCUMFERENCE = 2 * Math.PI * CIRCLE_RADIUS;
        let timer = null, isPaused = false, currentPhase = 'prepare', globalIntervalIndex = 0, secondsRemaining = 0, totalPhaseSeconds = 0, exerciseObjects = [];

        const timeLeftEl = document.getElementById('time-left');
        const roundDisplayEl = document.getElementById('round-display');
        const circuitDisplayEl = document.getElementById('circuit-display');
        const totalTimeDisplayEl = document.getElementById('total-time-display');
        const exerciseTextEl = document.getElementById('current-exercise');
        const progressCircle = document.getElementById('progress-circle');
        const navIndicator = document.getElementById('nav-indicator');
        const btnMute = document.getElementById('btn-mute');
        const iconMuted = document.getElementById('icon-muted');
        const iconUnmuted = document.getElementById('icon-unmuted');
        const btnStart = document.getElementById('btn-start');
        const btnPause = document.getElementById('btn-pause');
        const nextUpContainer = document.getElementById('next-up-container');
        const nextExerciseNameEl = document.getElementById('next-exercise-name');
        const inputWork = document.getElementById('input-work'), inputRest = document.getElementById('input-rest'), inputRounds = document.getElementById('input-rounds'), inputPrepare = document.getElementById('input-prepare'), inputExercises = document.getElementById('input-exercises');
        
        // Voice state variable (controlled by mute button)
        let voiceEnabled = true;

        function saveSettings() {
            const settings = {
                exercises: inputExercises.value,
                workTime: getSecondsFromTimeInput('input-work'),
                restTime: getSecondsFromTimeInput('input-rest'),
                circuits: inputRounds.value,
                prepTime: getSecondsFromTimeInput('input-prepare'),
                voiceEnabled: voiceEnabled
            };
            localStorage.setItem('intervalTimerSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('intervalTimerSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    inputExercises.value = settings.exercises || inputExercises.value;
                    
                    // Load time values
                    if (settings.workTime !== undefined) {
                        setTimeInputSeconds('input-work', settings.workTime);
                    }
                    if (settings.restTime !== undefined) {
                        setTimeInputSeconds('input-rest', settings.restTime);
                    }
                    if (settings.prepTime !== undefined) {
                        setTimeInputSeconds('input-prepare', settings.prepTime);
                    }
                    
                    inputRounds.value = settings.circuits || inputRounds.value;
                    voiceEnabled = settings.voiceEnabled !== undefined ? settings.voiceEnabled : true;
                    handleMuteToggle(voiceEnabled);
                } catch (e) {
                    console.error('Error loading settings:', e);
                }
            }
        }

        function setupAutoSave() {
            [inputExercises, inputWork, inputRest, inputRounds, inputPrepare].forEach(el => {
                el.addEventListener('input', () => {
                    saveSettings();
                    updateTotalTimeDisplay();
                });
            });
        }

        // ============================================
        // TIME INPUT HELPERS (MM:SS format)
        // ============================================
        function parseTimeInput(value) {
            // Remove any spaces
            value = value.trim();
            
            // If contains colon, parse as MM:SS
            if (value.includes(':')) {
                const parts = value.split(':');
                const min = parseInt(parts[0]) || 0;
                const sec = parseInt(parts[1]) || 0;
                return min * 60 + sec;
            }
            
            // Otherwise treat as seconds
            return parseInt(value) || 0;
        }

        function formatToMMSS(seconds) {
            seconds = Math.max(0, seconds); // No negatives
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        function handleTimeBlur(inputId) {
            const input = document.getElementById(inputId);
            const seconds = parseTimeInput(input.value);
            input.setAttribute('data-seconds', seconds);
            input.value = formatToMMSS(seconds);
            
            // Trigger save and update
            saveSettings();
            updateTotalTimeDisplay();
        }

        function getSecondsFromTimeInput(inputId) {
            const input = document.getElementById(inputId);
            return parseInt(input.getAttribute('data-seconds')) || 0;
        }

        function setTimeInputSeconds(inputId, seconds) {
            const input = document.getElementById(inputId);
            seconds = Math.max(0, seconds);
            input.setAttribute('data-seconds', seconds);
            input.value = formatToMMSS(seconds);
            
            // Trigger save and update
            input.dispatchEvent(new Event('input'));
        }

        // ============================================
        // INCREMENT/DECREMENT WITH LONG-PRESS (for time inputs)
        // ============================================
        let adjustmentInterval = null;
        let adjustmentTimeout = null;
        let speedUpTimeout = null;

        function incrementTimeValue(inputId) {
            const seconds = getSecondsFromTimeInput(inputId);
            setTimeInputSeconds(inputId, seconds + 5); // +5 seconds
            
            // Haptic feedback on mobile
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }

        function decrementTimeValue(inputId) {
            const seconds = getSecondsFromTimeInput(inputId);
            setTimeInputSeconds(inputId, seconds - 5); // -5 seconds
            
            // Haptic feedback on mobile
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }

        function startTimeIncrement(inputId) {
            incrementTimeValue(inputId);
            
            adjustmentTimeout = setTimeout(() => {
                adjustmentInterval = setInterval(() => {
                    incrementTimeValue(inputId);
                }, 150);
                
                speedUpTimeout = setTimeout(() => {
                    clearInterval(adjustmentInterval);
                    adjustmentInterval = setInterval(() => {
                        incrementTimeValue(inputId);
                    }, 75);
                }, 2000);
            }, 500);
        }

        function startTimeDecrement(inputId) {
            decrementTimeValue(inputId);
            
            adjustmentTimeout = setTimeout(() => {
                adjustmentInterval = setInterval(() => {
                    decrementTimeValue(inputId);
                }, 150);
                
                speedUpTimeout = setTimeout(() => {
                    clearInterval(adjustmentInterval);
                    adjustmentInterval = setInterval(() => {
                        decrementTimeValue(inputId);
                    }, 75);
                }, 2000);
            }, 500);
        }

        function stopAdjustment() {
            clearTimeout(adjustmentTimeout);
            clearTimeout(speedUpTimeout);
            clearInterval(adjustmentInterval);
            adjustmentTimeout = null;
            speedUpTimeout = null;
            adjustmentInterval = null;
        }

        // ============================================
        // CIRCUITS INCREMENT/DECREMENT (still uses +/- 1)
        // ============================================
        function incrementValue(inputId) {
            const input = document.getElementById(inputId);
            const currentValue = parseInt(input.value) || 0;
            const min = parseInt(input.min) || 0;
            const max = parseInt(input.max) || 999;
            
            if (currentValue < max) {
                input.value = currentValue + 1;
                input.dispatchEvent(new Event('input'));
                
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            }
        }

        function decrementValue(inputId) {
            const input = document.getElementById(inputId);
            const currentValue = parseInt(input.value) || 0;
            const min = parseInt(input.min) || 0;
            
            if (currentValue > min) {
                input.value = currentValue - 1;
                input.dispatchEvent(new Event('input'));
                
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            }
        }

        function startIncrement(inputId) {
            incrementValue(inputId);
            
            adjustmentTimeout = setTimeout(() => {
                adjustmentInterval = setInterval(() => {
                    incrementValue(inputId);
                }, 150);
                
                speedUpTimeout = setTimeout(() => {
                    clearInterval(adjustmentInterval);
                    adjustmentInterval = setInterval(() => {
                        incrementValue(inputId);
                    }, 75);
                }, 2000);
            }, 500);
        }

        function startDecrement(inputId) {
            decrementValue(inputId);
            
            adjustmentTimeout = setTimeout(() => {
                adjustmentInterval = setInterval(() => {
                    decrementValue(inputId);
                }, 150);
                
                speedUpTimeout = setTimeout(() => {
                    clearInterval(adjustmentInterval);
                    adjustmentInterval = setInterval(() => {
                        decrementValue(inputId);
                    }, 75);
                }, 2000);
            }, 500);
        }


        function switchTab(tab) {
            const timerView = document.getElementById('view-timer');
            const settingsView = document.getElementById('view-settings');
            const tabTimerBtn = document.getElementById('tab-timer');
            const tabSettingsBtn = document.getElementById('tab-settings');

            if (tab === 'timer') {
                settingsView.classList.remove('active');
                timerView.classList.add('active');
                tabTimerBtn.classList.add('tab-active');
                tabSettingsBtn.classList.remove('tab-active');
                navIndicator.style.transform = 'translateX(0%)';
                updateTotalTimeDisplay();
            } else {
                timerView.classList.remove('active');
                settingsView.classList.add('active');
                tabSettingsBtn.classList.add('tab-active');
                tabTimerBtn.classList.remove('tab-active');
                navIndicator.style.transform = 'translateX(100%)';
                if (timer && !isPaused) togglePause();
            }
        }

        function toggleMute() { 
            voiceEnabled = !voiceEnabled; 
            handleMuteToggle(voiceEnabled);
            saveSettings();
        }
        
        function handleMuteToggle(isUnmuted) {
            if (isUnmuted) { 
                btnMute.classList.remove('is-muted'); 
                iconMuted.classList.add('hidden'); 
                iconUnmuted.classList.remove('hidden'); 
            } else { 
                btnMute.classList.add('is-muted'); 
                iconMuted.classList.remove('hidden'); 
                iconUnmuted.classList.add('hidden'); 
                speechManager.cancel();
            }
        }
        
        function speak(text) { 
            speechManager.speak(text, voiceEnabled);
        }
        
        function updateProgress(percent) { progressCircle.style.strokeDashoffset = CIRCUMFERENCE - (percent / 100 * CIRCUMFERENCE); }
        function formatTime(seconds) { return `${Math.floor(seconds / 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`; }
        function parseExercises() { 
            const defaultWork = getSecondsFromTimeInput('input-work'); 
            return inputExercises.value.split(',').filter(i => i.trim() !== "").map(item => { 
                const parts = item.split(':'); 
                return { 
                    name: parts[0].trim(), 
                    duration: parts[1] ? parseInt(parts[1].trim()) : defaultWork 
                }; 
            }); 
        }
        
        function calculateTotalTime() {
            const exercises = parseExercises();
            if (exercises.length === 0) return 0;
            
            const circuits = parseInt(inputRounds.value);
            const restTime = getSecondsFromTimeInput('input-rest');
            const prepTime = getSecondsFromTimeInput('input-prepare');
            
            let totalWorkTime = 0;
            exercises.forEach(ex => {
                totalWorkTime += ex.duration;
            });
            
            const totalTime = prepTime + (totalWorkTime * circuits) + (restTime * (exercises.length * circuits - 1));
            
            return totalTime;
        }
        
        function updateTotalTimeDisplay() {
            const totalSeconds = calculateTotalTime();
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            totalTimeDisplayEl.innerText = `Total: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function getIntervalData(index) { 
            const listSize = exerciseObjects.length; 
            if (listSize === 0) return null; 
            return { 
                exercise: exerciseObjects[index % listSize], 
                exerciseNum: (index % listSize) + 1, 
                circuitNum: Math.floor(index / listSize) + 1, 
                isLastOverall: (index === (listSize * parseInt(inputRounds.value)) - 1) 
            }; 
        }

        function setVisualState(phase) {
            const colors = { prepare: 'text-blue-500', work: 'text-emerald-500', rest: 'text-orange-500' };
            const textColors = { prepare: 'text-blue-400', work: 'text-emerald-400', rest: 'text-orange-400' };
            
            progressCircle.classList.remove('text-blue-500', 'text-emerald-500', 'text-orange-500', 'text-yellow-300', 'text-yellow-400');
            progressCircle.classList.add(colors[phase]);
            
            exerciseTextEl.classList.remove('text-blue-400', 'text-emerald-400', 'text-orange-400', 'text-yellow-300', 'text-yellow-400');
            exerciseTextEl.classList.add(textColors[phase]);
            
            
            if (phase === 'prepare') {
                exerciseTextEl.innerText = "Get Ready";
                const info = getIntervalData(0);
                nextExerciseNameEl.innerText = info.exercise.name;
                nextUpContainer.classList.replace('opacity-0', 'opacity-100');
                nextUpContainer.classList.remove('translate-y-2');
                totalTimeDisplayEl.style.opacity = '1';
                speak(`Get ready. First, ${info.exercise.name}.`);
            } else if (phase === 'rest') {
                exerciseTextEl.innerText = "Rest";
                const info = getIntervalData(globalIntervalIndex + 1);
                nextExerciseNameEl.innerText = info.exercise.name;
                nextUpContainer.classList.replace('opacity-0', 'opacity-100');
                nextUpContainer.classList.remove('translate-y-2');
                totalTimeDisplayEl.style.opacity = '0';
                speak(`Rest. Next is ${info.exercise.name}.`);
            } else {
                const info = getIntervalData(globalIntervalIndex);
                exerciseTextEl.innerText = info.exercise.name;
                roundDisplayEl.innerText = `Exercise ${info.exerciseNum} / ${exerciseObjects.length}`;
                circuitDisplayEl.innerText = `Circuit ${info.circuitNum} / ${inputRounds.value}`;
                totalTimeDisplayEl.style.opacity = '0';
                
                if (!info.isLastOverall) {
                    nextExerciseNameEl.innerText = "Rest";
                    nextUpContainer.classList.replace('opacity-0', 'opacity-100');
                    nextUpContainer.classList.remove('translate-y-2');
                } else {
                    nextUpContainer.classList.replace('opacity-100', 'opacity-0');
                    nextUpContainer.classList.add('translate-y-2');
                }
                speak(info.exercise.name + ". Begin.");
                //speak(info.exercise.name + ". Start.");
            }
        }

        function tick() {
            if (isPaused) return;
            if (secondsRemaining > 0) {
                secondsRemaining--;
                timeLeftEl.innerText = formatTime(secondsRemaining);
                updateProgress((secondsRemaining / totalPhaseSeconds) * 100);
                if (secondsRemaining <= 3 && secondsRemaining > 0) speak(secondsRemaining.toString());
            } else { nextPhase(); }
        }

        function nextPhase() {
            if (!timer) return;
            if (currentPhase === 'prepare') { currentPhase = 'work'; globalIntervalIndex = 0; totalPhaseSeconds = getIntervalData(0).exercise.duration; }
            else if (currentPhase === 'work') { if (getIntervalData(globalIntervalIndex).isLastOverall) { completeWorkout(); return; } currentPhase = 'rest'; totalPhaseSeconds = getSecondsFromTimeInput('input-rest'); }
            else { globalIntervalIndex++; currentPhase = 'work'; totalPhaseSeconds = getIntervalData(globalIntervalIndex).exercise.duration; }
            secondsRemaining = totalPhaseSeconds;
            setVisualState(currentPhase);
            timeLeftEl.innerText = formatTime(secondsRemaining);
            updateProgress(100);
        }

        async function startWorkout() {
            exerciseObjects = parseExercises();
            if (exerciseObjects.length === 0) return;
            
            // Clean up any completion animations from previous workout
            exerciseTextEl.classList.remove('pulse-text', 'text-yellow-300', 'text-yellow-400');
            progressCircle.classList.remove('pulse-circle-stroke', 'text-yellow-300', 'text-yellow-400');
            
            // Remove completion glow if it exists
            const completionGlow = document.getElementById('completion-glow');
            if (completionGlow) completionGlow.remove();
            
            speechManager.initialize();
            await wakeLockManager.enable();
            
            const prep = getSecondsFromTimeInput('input-prepare');
            isPaused = false;
            currentPhase = prep > 0 ? 'prepare' : 'work';
            totalPhaseSeconds = prep > 0 ? prep : getIntervalData(0).exercise.duration;
            secondsRemaining = totalPhaseSeconds;
            
            timeLeftEl.innerText = formatTime(secondsRemaining); 
            updateProgress(100); // Set initial progress to full
            
            setVisualState(currentPhase);
            btnStart.classList.add('hidden');
            btnPause.classList.remove('hidden');
            
            // Start timer AFTER displaying initial state
            timer = setInterval(tick, 1000);
            switchTab('timer');
        }

        async function togglePause() { 
            if (!timer) return; 
            isPaused = !isPaused; 
            
            if (isPaused) {
                await wakeLockManager.disable();
                speechManager.cancel();
            } else {
                await wakeLockManager.enable();
            }
            
            btnStart.classList.toggle('hidden', !isPaused); 
            btnPause.classList.toggle('hidden', isPaused); 
        }
        
        async function completeWorkout() { 
            clearInterval(timer); 
            timer = null; 
            
            await wakeLockManager.disable();
            
            // Visual celebration - synchronized pulsing
            
            // Change text to soft pastel yellow
            exerciseTextEl.innerText = "Amazing!"; 
            exerciseTextEl.classList.remove('text-blue-400', 'text-emerald-500', 'text-orange-500');
            exerciseTextEl.classList.add('text-yellow-300');
            
            // Add pulsing to text
            exerciseTextEl.classList.add('pulse-text');
            
            // Make the circle full (100%) so entire circle glows
            updateProgress(100);
            
            // Make progress circle pulse
            progressCircle.classList.add('pulse-circle-stroke');
            
            // Add circular radial glow behind the circle - soft pastel yellow
            const progressContainer = document.querySelector('.progress-svg-container');
            const glowDiv = document.createElement('div');
            glowDiv.className = 'pulse-radial-glow';
            glowDiv.id = 'completion-glow';
            progressContainer.insertBefore(glowDiv, progressContainer.firstChild);
            
            // Vibration feedback (if supported)
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
            
            // Make progress circle soft yellow for completion
            progressCircle.classList.remove('text-blue-500', 'text-emerald-500', 'text-orange-500', 'text-yellow-400');
            progressCircle.classList.add('text-yellow-300');
            
            nextUpContainer.classList.replace('opacity-100', 'opacity-0');
            btnStart.classList.remove('hidden'); 
            btnPause.classList.add('hidden'); 
            speak("Workout complete! Great job!"); 
        }

        // ============================================
        // SOFT RESET FUNCTION (No Page Reload)
        // ============================================
        async function resetTimer() {
            console.log('ðŸ”„ Soft reset initiated');
            
            // Stop and clear timer
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            
            // Cleanup resources
            await wakeLockManager.disable();
            speechManager.cancel();
            
            // Reset all state variables
            isPaused = false;
            currentPhase = 'prepare';
            globalIntervalIndex = 0;
            secondsRemaining = 0;
            totalPhaseSeconds = 0;
            exerciseObjects = [];
            
            // Reset UI - Status and Exercise
            exerciseTextEl.innerText = 'Get Ready';
            exerciseTextEl.classList.remove('text-yellow-300', 'text-yellow-400', 'text-blue-400', 'text-emerald-400', 'text-orange-400', 'pulse-text');
            exerciseTextEl.classList.add('text-blue-400');
            timeLeftEl.innerText = '00:00';
            roundDisplayEl.innerText = 'Ready';
            circuitDisplayEl.innerText = ' ';
            
            // Reset total time display
            totalTimeDisplayEl.style.opacity = '1';
            updateTotalTimeDisplay();
            
            // Hide "Next Up" section
            nextUpContainer.classList.add('opacity-0');
            nextUpContainer.classList.add('translate-y-2');
            
            // Reset buttons
            btnStart.classList.remove('hidden');
            btnPause.classList.add('hidden');
            
            // Reset progress circle
            progressCircle.classList.remove('text-emerald-500', 'text-orange-500', 'text-yellow-400', 'text-yellow-300', 'pulse-circle-stroke');
            progressCircle.classList.add('text-blue-500');
            updateProgress(0);
            
            // Remove celebration glow
            const completionGlow = document.getElementById('completion-glow');
            if (completionGlow) completionGlow.remove();
            
            // Switch to timer tab
            switchTab('timer');
            
            console.log('âœ“ Reset complete');
        }

        btnStart.addEventListener('click', () => timer && isPaused ? togglePause() : startWorkout());
        btnPause.addEventListener('click', togglePause);
        document.getElementById('btn-reset').addEventListener('click', resetTimer);

        progressCircle.style.strokeDasharray = `${CIRCUMFERENCE} ${CIRCUMFERENCE}`;
        window.onload = () => {
            loadSettings();
            setupAutoSave();
            timeLeftEl.innerText = formatTime(0);
            updateTotalTimeDisplay();
        };

        window.addEventListener('beforeunload', async () => {
            await wakeLockManager.disable();
            speechManager.cancel();
        });
    </script>
</body>
</html>
